<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Погода METAR (UAAA)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <main class="weather-card">
        <h2>Погода в <span id="location">...</span></h2>
        <p class="time">Данные на: <span id="obsTime">...</span></p>

        <div class="weather-grid">
            <div class="grid-item">
                <strong>Температура:</strong>
                <span id="temp">...</span>
            </div>
            <div class="grid-item">
                <strong>Точка росы:</strong>
                <span id="dewp">...</span>
            </div>
            <div class="grid-item">
                <strong>Ветер (Напр/Скорость):</strong>
                <span id="wind">...</span>
            </div>
            <div class="grid-item">
                <strong>Видимость:</strong>
                <span id="visib">...</span>
            </div>
            <div class="grid-item">
                <strong>Давление (QNH):</strong>
                <span id="altim">...</span>
            </div>
            <div class="grid-item">
                <strong>Облачность:</strong>
                <span id="clouds">...</span>
            </div>
        </div>

        <h3>Исходная сводка (RAW):</h3>
        <code id="rawMetar">Загрузка...</code>
    </main>

    <script>
        // Эта функция выполнится, как только страница загрузится
        document.addEventListener('DOMContentLoaded', fetchMetar);

        async function fetchMetar() {
            // Выбираем все элементы, куда будем вставлять данные
            const elements = {
                location: document.getElementById('location'),
                obsTime: document.getElementById('obsTime'),
                temp: document.getElementById('temp'),
                dewp: document.getElementById('dewp'),
                wind: document.getElementById('wind'),
                visib: document.getElementById('visib'),
                altim: document.getElementById('altim'),
                clouds: document.getElementById('clouds'),
                rawMetar: document.getElementById('rawMetar'),
            };

            try {
                // 1. Делаем запрос к НАШЕЙ бессерверной функции
                // Мы не пишем https://... , Vercel сам поймет путь
                const response = await fetch('/api/metar');
                
                if (!response.ok) {
                    throw new Error('Ошибка сети при загрузке данных');
                }
                
                // 2. Получаем JSON от /api/metar
                const data = await response.json();

                // 3. Обновляем HTML на странице

                elements.location.textContent = data.name;
                
                // data.obsTime - это секунды (Unix time). Конвертируем в миллисекунды для Date()
                const obsDate = new Date(data.obsTime * 1000);
                // Форматируем в понятную дату и время
                elements.obsTime.textContent = obsDate.toLocaleString('ru-RU', { timeZone: 'UTC' }) + ' UTC';

                elements.temp.textContent = `${data.temp}°C`;
                elements.dewp.textContent = `${data.dewp}°C`;
                
                // JSON дает wdir (направление) и wspd (скорость в узлах)
                elements.wind.textContent = `${data.wdir}° / ${data.wspd} KTS`;
                
                // Видимость в "Statute Miles"
                elements.visib.textContent = `${data.visib} SM`; 
                
                // Давление в гектопаскалях
                elements.altim.textContent = `${data.altim} hPa`; 

                // Обрабатываем массив облачности
                if (data.clouds && data.clouds.length > 0) {
                    // map() превращает массив объектов в массив строк
                    elements.clouds.textContent = data.clouds
                        .map(c => `${c.cover} (рассеянная/сплошная) @ ${c.base} футов`)
                        .join(', '); // Соединяем строки, если облаков несколько
                } else {
                    elements.clouds.textContent = 'Нет значимой облачности';
                }

                elements.rawMetar.textContent = data.rawOb;

            } catch (error) {
                console.error('Ошибка при получении METAR:', error);
                document.querySelector('.weather-card').innerHTML = '<h2>Ошибка загрузки данных о погоде.</h2><p>Пожалуйста, попробуйте обновить страницу.</p>';
            }
        }
    </script>
</body>
</html>
