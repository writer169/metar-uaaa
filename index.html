<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Погода METAR (UAAA)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main class="weather-card">
        <h2>Погода в <span id="location">...</span></h2>
        <p class="time">Данные на: <span id="obsTime">...</span></p>
        <div class="weather-grid">
            <div class="grid-item">
                <strong>Температура:</strong>
                <span id="temp">...</span>
            </div>
            <div class="grid-item">
                <strong>Точка росы:</strong>
                <span id="dewp">...</span>
            </div>
            <div class="grid-item">
                <strong>Ветер (Напр/Скорость):</strong>
                <span id="wind">...</span>
            </div>
            <div class="grid-item">
                <strong>Видимость:</strong>
                <span id="visib">...</span>
            </div>
            <div class="grid-item">
                <strong>Давление (QNH):</strong>
                <span id="altim">...</span>
            </div>
            <div class="grid-item">
                <strong>Облачность:</strong>
                <span id="clouds">...</span>
            </div>
        </div>
        <h3>Исходная сводка (RAW):</h3>
        <code id="rawMetar">Загрузка...</code>
    </main>

    <script>
        // Словарь для "перевода" кодов облачности
        const CLOUD_TRANSLATIONS = {
            FEW: 'Незначительная',
            SCT: 'Рассеянная',
            BKN: 'Сплошная',
            OVC: 'Облачно',
        };

        document.addEventListener('DOMContentLoaded', fetchMetar);

        async function fetchMetar() {
            const elements = {
                location: document.getElementById('location'),
                obsTime: document.getElementById('obsTime'),
                temp: document.getElementById('temp'),
                dewp: document.getElementById('dewp'),
                wind: document.getElementById('wind'),
                visib: document.getElementById('visib'),
                altim: document.getElementById('altim'),
                clouds: document.getElementById('clouds'),
                rawMetar: document.getElementById('rawMetar'),
            };

            try {
                const response = await fetch('/api/metar');
                if (!response.ok) {
                    throw new Error('Ошибка сети при загрузке данных');
                }
                
                // 2. Получаем JSON, который сгенерировал metar-parser
                const data = await response.json();

                // 3. Обновляем HTML, используя НОВУЮ структуру данных
                
                // data.station вместо data.name
                elements.location.textContent = data.station; 
                
                // data.time - это объект {day, hour, minute}
                const time = data.time;
                // Дополняем нулями, если час/минута < 10
                const hour = String(time.hour).padStart(2, '0');
                const minute = String(time.minute).padStart(2, '0');
                elements.obsTime.textContent = `День ${time.day}, ${hour}:${minute} UTC`;

                // data.temperature вместо data.temp
                elements.temp.textContent = `${data.temperature}°C`;
                // data.dewpoint вместо data.dewp
                elements.dewp.textContent = `${data.dewpoint}°C`;
                
                // data.wind - это объект { direction, speed, unit }
                const wind = data.wind;
                elements.wind.textContent = `${wind.direction}° / ${wind.speed} ${wind.unit}`;
                
                // data.visibility - это объект { value, unit }
                const vis = data.visibility;
                elements.visib.textContent = `${vis.value}${vis.unit}`; // (например, 9999M)
                
                // data.altimeter - это объект { value, unit }
                const altim = data.altimeter;
                elements.altim.textContent = `${altim.value} ${altim.unit}`; // (например, 1032 hPa)

                // data.clouds - массив. Эта логика стала даже лучше
                if (data.clouds && data.clouds.length > 0) {
                    elements.clouds.textContent = data.clouds
                        .map(c => {
                            // Используем наш словарь для перевода
                            const coverText = CLOUD_TRANSLATIONS[c.cover] || c.cover;
                            return `${coverText} @ ${c.base} футов`;
                        })
                        .join(', ');
                } else {
                    elements.clouds.textContent = 'Нет значимой облачности';
                }

                // data.raw вместо data.rawOb
                elements.rawMetar.textContent = data.raw;

            } catch (error) {
                console.error('Ошибка при получении METAR:', error);
                document.querySelector('.weather-card').innerHTML = '<h2>Ошибка загрузки данных о погоде.</h2><p>Пожалуйста, попробуйте обновить страницу.</p>';
            }
        }
    </script>
    </body>
</html>